import os
import json
import telebot
import gspread
from google.oauth2.service_account import Credentials
from datetime import datetime, timedelta
import re
import threading
import time
import schedule
import calendar
from flask import Flask

# üîë Google Sheets —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
creds_json = os.getenv("GOOGLE_CREDENTIALS")
creds_dict = json.loads(creds_json)
creds = Credentials.from_service_account_info(creds_dict)
client = gspread.authorize(creds)

# üìÑ –æ—Ç–∫—Ä—ã–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
SHEET_ID = os.getenv("GOOGLE_SHEET_ID")
spreadsheet = client.open_by_key(SHEET_ID)

# ü§ñ Telegram Bot
TOKEN = os.getenv("TELEGRAM_TOKEN")
bot = telebot.TeleBot(TOKEN)

print("‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω. –ñ–¥—É —Å–æ–æ–±—â–µ–Ω–∏–π...")

# Flask-–∑–∞–≥–ª—É—à–∫–∞ –¥–ª—è Render
app = Flask(__name__)

@app.route('/')
def home():
    return "Bot is running!"

# –ö–∞—Ç–µ–≥–æ—Ä–∏–∏
CATEGORIES = {
    "–ï–¥–∞": ["–µ–¥–∞", "–º–∞–Ω—Ç—ã", "–∫–∞—Ñ–µ", "–æ–±–µ–¥", "–ø—Ä–æ–¥—É–∫—Ç—ã", "—É–∂–∏–Ω"],
    "–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç": ["—Ç–∞–∫—Å–∏", "–∞–≤—Ç–æ–±—É—Å", "–±–µ–Ω–∑–∏–Ω", "—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç", "–ø—Ä–æ–µ–∑–¥"],
    "–ö–æ–º–º—É–Ω–∞–ª–∫–∞": ["—Å–≤–µ—Ç", "–≥–∞–∑", "–∂–∫—Ö", "–∏–Ω—Ç–µ—Ä–Ω–µ—Ç", "–≤–æ–¥–∞", "–∫–æ–º–º—É–Ω–∞–ª–∫–∞", "–∫–≤–∞—Ä–ø–ª–∞—Ç–∞"],
    "–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è": ["–∫–∏–Ω–æ", "–∏–≥—Ä–∞", "—Ç–µ–∞—Ç—Ä", "—Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏—è"],
    "–î—Ä—É–≥–æ–µ": []
}

ALLOWED_USERS = [476791477, 1388487185]
REPORT_CHAT_IDS = [476791477, 1388487185]

def send_to_all(text):
    for chat_id in REPORT_CHAT_IDS:
        try:
            bot.send_message(chat_id, text)
        except Exception as e:
            print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ {chat_id}: {e}")

def detect_category(text):
    text_lower = text.lower()
    for category, keywords in CATEGORIES.items():
        for word in keywords:
            if word in text_lower:
                return category
    return "–î—Ä—É–≥–æ–µ"

def get_current_worksheet():
    month_name = datetime.now().strftime("%B")
    try:
        worksheet = spreadsheet.worksheet(month_name)
    except gspread.exceptions.WorksheetNotFound:
        worksheet = spreadsheet.add_worksheet(title=month_name, rows="1000", cols="10")
        worksheet.append_row(["–î–∞—Ç–∞", "–ö–∞—Ç–µ–≥–æ—Ä–∏—è", "–°—É–º–º–∞", "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"])
    return worksheet

# ======= –ê–≤—Ç–æ–æ—Ç—á—ë—Ç—ã =======
def send_daily_report():
    try:
        worksheet = get_current_worksheet()
        today = datetime.now().strftime("%d.%m.%Y")
        all_records = worksheet.get_all_values()[1:]
        today_sum = sum(int(row[2]) for row in all_records if row[0] == today)
        send_to_all(f"üåô –í–µ—á–µ—Ä–Ω–∏–π –æ—Ç—á—ë—Ç –∑–∞ {today}:\n–ü–æ—Ç—Ä–∞—Ç–∏–ª–∏ —Å–µ–≥–æ–¥–Ω—è ‚Äî {today_sum} ‚Ç∏")
    except Exception as e:
        send_to_all(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –≤ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–º –æ—Ç—á—ë—Ç–µ: {e}")

def send_weekly_report():
    try:
        worksheet = get_current_worksheet()
        today = datetime.now()
        week_ago = today - timedelta(days=7)
        all_records = worksheet.get_all_values()[1:]
        week_sum = 0
        for row in all_records:
            date_obj = datetime.strptime(row[0], "%d.%m.%Y")
            if week_ago <= date_obj <= today:
                week_sum += int(row[2])
        send_to_all(f"üìÖ –ò—Ç–æ–≥ –∑–∞ –Ω–µ–¥–µ–ª—é (–¥–æ {today.strftime('%d.%m.%Y')}):\n{week_sum} ‚Ç∏")
    except Exception as e:
        send_to_all(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –≤ –Ω–µ–¥–µ–ª—å–Ω–æ–º –æ—Ç—á—ë—Ç–µ: {e}")

def send_monthly_report():
    try:
        worksheet = get_current_worksheet()
        today = datetime.now()
        month = today.strftime("%m.%Y")
        all_records = worksheet.get_all_values()[1:]
        month_sum = sum(int(row[2]) for row in all_records if month in row[0])
        send_to_all(f"üìä –ò—Ç–æ–≥ –∑–∞ –º–µ—Å—è—Ü {today.strftime('%B')}:\n{month_sum} ‚Ç∏")
    except Exception as e:
        send_to_all(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –≤ –º–µ—Å—è—á–Ω–æ–º –æ—Ç—á—ë—Ç–µ: {e}")

# ======= –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ =======
schedule.every().day.at("22:00").do(send_daily_report)
schedule.every().sunday.at("22:30").do(send_weekly_report)
schedule.every().day.at("23:59").do(
    lambda: send_monthly_report() if datetime.now().day == calendar.monthrange(datetime.now().year, datetime.now().month)[1] else None
)

def schedule_checker():
    while True:
        schedule.run_pending()
        time.sleep(30)

threading.Thread(target=schedule_checker, daemon=True).start()

# ======= –ö–æ–º–∞–Ω–¥—ã =======
@bot.message_handler(commands=['id'])
def send_id(message):
    bot.reply_to(message, f"–í–∞—à chat_id: {message.chat.id}")

@bot.message_handler(commands=['report'])
def report(message):
    if message.chat.id not in ALLOWED_USERS:
        bot.reply_to(message, "‚õî –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–º—É –±–æ—Ç—É.")
        return
    try:
        worksheet = get_current_worksheet()
        today = datetime.now().strftime("%d.%m.%Y")
        month = datetime.now().strftime("%m.%Y")
        all_records = worksheet.get_all_values()[1:]
        today_sum = sum(int(row[2]) for row in all_records if row[0] == today)
        month_sum = sum(int(row[2]) for row in all_records if month in row[0])
        bot.reply_to(message,
            f"üìä –û—Ç—á—ë—Ç:\n"
            f"–°–µ–≥–æ–¥–Ω—è ({today}) ‚Äî {today_sum} ‚Ç∏\n"
            f"–ó–∞ –º–µ—Å—è—Ü ‚Äî {month_sum} ‚Ç∏")
    except Exception as e:
        bot.reply_to(message, f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –≤ /report: {e}")

@bot.message_handler(func=lambda m: True)
def add_or_auto(message):
    if message.chat.id not in ALLOWED_USERS:
        bot.reply_to(message, "‚õî –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–º—É –±–æ—Ç—É.")
        return
    print(f"üì© –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ: {message.text} –æ—Ç {message.chat.id}")
    if message.text.startswith("/add"):
        try:
            parts = message.text.split(maxsplit=3)
            category = parts[1]
            amount = parts[2]
            comment = parts[3] if len(parts) > 3 else ""
        except:
            bot.reply_to(message, "‚ö†Ô∏è –§–æ—Ä–º–∞—Ç: /add –ö–∞—Ç–µ–≥–æ—Ä–∏—è –°—É–º–º–∞ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π")
            return
    else:
        try:
            amount_match = re.search(r'\d+', message.text)
            if not amount_match:
                bot.reply_to(message, "‚ö†Ô∏è –£–∫–∞–∂–∏ —Å—É–º–º—É.")
                return
            amount = amount_match.group()
            comment = message.text.replace(amount, "").strip()
            category = detect_category(message.text)
        except:
            bot.reply_to(message, "‚ö†Ô∏è –ù–µ –ø–æ–Ω—è–ª —Å–æ–æ–±—â–µ–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π —Ñ–æ—Ä–º–∞—Ç: /add –ö–∞—Ç–µ–≥–æ—Ä–∏—è –°—É–º–º–∞ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π")
            return
    today = datetime.now().strftime("%d.%m.%Y")
    worksheet = get_current_worksheet()
    worksheet.append_row([today, category, amount, comment])
    bot.reply_to(message, f"‚úÖ –ó–∞–ø–∏—Å—å: {category} ‚Äî {amount} ‚Ç∏ ({comment})")

# –ó–∞–ø—É—Å–∫ Flask –∏ –±–æ—Ç–∞
if __name__ == "__main__":
    threading.Thread(target=lambda: bot.infinity_polling(), daemon=True).start()
    app.run(host="0.0.0.0", port=int(os.getenv("PORT", 5000)))
